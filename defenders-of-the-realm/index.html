<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Defenders of the Realm</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
</head>
<body>
    <!-- â”€â”€ SPLASH SCREEN â”€â”€ -->
    <div id="splash-screen">
        <div class="ambient-bg"></div>
        <canvas id="splash-particles"></canvas>
        <div class="ornament tl">âšœ</div>
        <div class="ornament tr">âšœ</div>
        <div class="ornament bl">âšœ</div>
        <div class="ornament br">âšœ</div>
        <div class="splash-image-wrapper">
            <img class="splash-image" src="images/splash-screen.jpg" alt="Defenders of the Realm" />
            <div class="image-vignette"></div>
            <div class="version-badge">v5.3.11</div>
        </div>
        <div class="splash-bottom">
            <div class="loading-container" id="splash-loading-container">
                <div class="loading-bar"></div>
            </div>
            <div class="splash-loading-text" id="splash-loading-text">Summoning Heroes...</div>
            <button class="start-btn" id="splash-start-btn">
                <span style="font-size:22px">âš”</span> Enter the Realm
            </button>
        </div>
    </div>
    <script src="js/splash.js"></script>
    <!-- â”€â”€ END SPLASH SCREEN â”€â”€ -->
    <div class="game-container">
        <div class="game-header">
            <h1 class="modal-heading" style="font-size:1.5em;color:#ffd700;margin-bottom:8px;">âš”ï¸ Defenders of the Realm âš”ï¸</h1>
            <div class="modal-desc-text" style="font-size: 0.75em; color: #d4af37; margin-top: 5px;">Version 5.3.11 - Beta</div>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px; flex-wrap: wrap;">
                <button class="phase-btn" style="width:auto;margin-top:0;padding:8px 14px;font-size:0.85em;" onclick="game.showRules()">ğŸ“œ Rules</button>
                <button class="phase-btn" style="width:auto;margin-top:0;padding:8px 14px;font-size:0.85em;" onclick="game.showTips()">ğŸ’¡ Tips</button>
                <button class="phase-btn" style="width:auto;margin-top:0;padding:8px 14px;font-size:0.85em;" onclick="game.showReleaseNotes()">ğŸ“‹ Release Notes</button>
                <button class="phase-btn" style="width:auto;margin-top:0;padding:8px 14px;font-size:0.85em;" onclick="game.showSettings()">âš™ï¸ Settings</button>
                <button class="phase-btn" style="width:auto;margin-top:0;padding:8px 14px;font-size:0.85em;background:linear-gradient(135deg,#dc2626,#991b1b);border-color:#dc2626;color:#fff;" onclick="if(confirm('Quit game and return to setup?')) window.close()">ğŸšª Quit Game</button>
            </div>
        </div>

        <div class="controls-panel">
            <div class="section-tray">
                <div class="tray-title modal-heading" style="font-size:1.1em;color:#ffd700;">Play Area</div>
                <div class="action-buttons">
                    <button class="phase-btn" style="width:auto;margin-top:0;padding:8px 14px;font-size:0.85em;" onclick="game.showMap()">ğŸ—ºï¸ Game Board</button>
                    <button class="phase-btn" style="width:auto;margin-top:0;padding:8px 14px;font-size:0.85em;" onclick="game.showHeroesModal()">ğŸ‘¥ View Heroes</button>
                </div>
            </div>

            <div class="section-tray">
                <div class="tray-title modal-heading" style="font-size:1.1em;color:#ffd700;">Card Decks</div>
                <div class="deck-placard-grid">
                    <!-- Hero Cards Deck -->
                    <div class="general-placard">
                        <div class="general-banner" style="background: linear-gradient(135deg, #8b6914cc 0%, #6b500faa 100%);">
                            <div>
                                <div class="general-banner-name">ğŸ´ Hero Cards</div>
                            </div>
                        </div>
                        <div class="general-body deck-body">
                            <div class="deck-stat-row">
                                <div class="deck-stat">
                                    <div class="deck-stat-number" id="hero-deck-count">81</div>
                                    <div class="deck-stat-label">Remaining</div>
                                </div>
                                <div class="deck-stat-divider"></div>
                                <div class="deck-stat">
                                    <div class="deck-stat-number muted" id="hero-discard-count">0</div>
                                    <div class="deck-stat-label">Discard</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quest Cards Deck -->
                    <div class="general-placard">
                        <div class="general-banner" style="background: linear-gradient(135deg, #b91c1ccc 0%, #991b1baa 100%);">
                            <div>
                                <div class="general-banner-name">ğŸ“œ Quest Cards</div>
                            </div>
                        </div>
                        <div class="general-body deck-body">
                            <div class="deck-stat-row">
                                <div class="deck-stat">
                                    <div class="deck-stat-number" id="quest-deck-count">24</div>
                                    <div class="deck-stat-label">Remaining</div>
                                </div>
                                <div class="deck-stat-divider"></div>
                                <div class="deck-stat">
                                    <div class="deck-stat-number muted" id="quest-discard-count">0</div>
                                    <div class="deck-stat-label">Discard</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Darkness Spreads Deck -->
                    <div class="general-placard">
                        <div class="general-banner" style="background: linear-gradient(135deg, #6d28d9cc 0%, #5b21b6aa 100%);">
                            <div>
                                <div class="general-banner-name">ğŸŒ‘ Darkness Spreads</div>
                            </div>
                        </div>
                        <div class="general-body deck-body">
                            <div class="deck-stat-row">
                                <div class="deck-stat">
                                    <div class="deck-stat-number" id="darkness-deck-count">49</div>
                                    <div class="deck-stat-label">Remaining</div>
                                </div>
                                <div class="deck-stat-divider"></div>
                                <div class="deck-stat">
                                    <div class="deck-stat-number muted" id="darkness-discard-count">0</div>
                                    <div class="deck-stat-label">Discard</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-tray">
                <div class="tray-title modal-heading" style="font-size:1.1em;color:#ffd700;">Enemy Generals</div>
                <div class="generals-panel" id="generals-panel"></div>
            </div>
            
            <div class="general-placard" id="war-status-tracker">
                <div class="general-banner" style="background: linear-gradient(135deg, #8b6914cc 0%, #6b500faa 100%);">
                    <div>
                        <div class="general-banner-name">âš”ï¸ War Status</div>
                    </div>
                </div>
                <div class="general-body">
                    <div class="war-advance-text">Advance 1 space for each General defeated</div>
                    <div style="display: flex; gap: 12px;">
                    <!-- Vertical tracker -->
                    <div class="war-tracker-col">
                        <div class="war-box"><span class="war-icon">âš”ï¸</span><span class="war-label">Early</span></div>
                        <div class="war-arrow">â–¼</div>
                        <div class="war-box"><span class="war-icon"></span><span class="war-label">Mid</span></div>
                        <div class="war-box"><span class="war-icon"></span><span class="war-label">Mid</span></div>
                        <div class="war-arrow">â–¼</div>
                        <div class="war-box"><span class="war-icon"></span><span class="war-label">Late</span></div>
                    </div>
                    <!-- Descriptions -->
                    <div style="flex: 1; min-width: 0;">
                        <div class="g-section">
                            <div class="g-section-label"><strong>Early War</strong></div>
                            <div class="g-section-text">Each player draws 1 Darkness Spreads card at the end of their turn, placing minions and moving Generals as noted.</div>
                        </div>
                        <br>
                        <div class="g-section">
                            <div class="g-section-label"><strong>Mid War</strong></div>
                            <div class="g-section-text">Each player draws 2 Darkness Spreads cards at the end of their turn. The 1st card is used to place minions and move a General, and the 2nd card is used for General movement only.</div>
                        </div>
                        <br>
                        <div class="g-section">
                            <div class="g-section-label"><strong>Late War</strong></div>
                            <div class="g-section-text">Each player draws 3 Darkness Spreads cards at the end of their turn. The first 2 cards are used to place minions and move Generals, and the 3rd card is used for General movement only.</div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Setup Modal -->
    <div class="modal active" id="setup-modal">
        <div class="modal-content" style="padding-top: 20px;">
            <div class="modal-heading" style="color: #d4af37; margin: 0; font-size: 1.15em; text-align: center; margin-bottom: 12px;">âš”ï¸ Hero Selection</div>
            <div class="modal-desc-text" style="margin-bottom: 15px; text-align: center; font-size: 0.75em; color: #ccc;">Select your heroes (1-4 players)</div>
            <div id="hero-selection"></div>
            
            <!-- White Rabbit Test General (hidden) -->
            <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border: 2px solid #999; border-radius: 8px; display: none;">
                <label style="display: flex; align-items: center; cursor: pointer; user-select: none;">
                    <input type="checkbox" id="white-rabbit-checkbox" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                    <div>
                        <div style="font-weight: bold; color: #ffd700;">ğŸ° White Rabbit (Test General)</div>
                        <div style="font-size: 0.85em; color: #999; margin-top: 5px;">
                            3 life tokens â€¢ Uses black cards â€¢ Father Oak Forest â€¢ For testing only
                        </div>
                    </div>
                </label>
            </div>
            
            <button class="phase-btn" style="margin-top: 15px;" onclick="game.startGame()">
                Start Game
            </button>
        </div>
    </div>

    <!-- General Card Selection Modal -->
    <div class="modal" id="general-card-selection-modal" style="z-index: 12000;">
        <div class="modal-content" style="max-width: 600px;">
            <h2 class="modal-title">âš”ï¸ Select Cards for Attack</h2>
            <div id="general-card-selection-content"></div>
            <div id="general-card-selection-buttons" style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn btn-primary" style="flex: 1;" onclick="game.confirmGeneralAttack();">
                    âš”ï¸ Attack
                </button>
                <button class="btn" style="flex: 1;" onclick="game.cancelGeneralAttack()">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    
    <!-- Combat Modal -->
    <div class="modal" id="combat-modal" style="z-index: 15000;">
        <div class="modal-content">
            <h2 class="modal-title" id="combat-title">Combat</h2>
            <div id="combat-content"></div>
            <div class="dice-roll" id="dice-display"></div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn btn-primary" style="flex: 1;" id="combat-roll-btn" onclick="game.rollCombatDice()">
                    ğŸ² Roll Dice
                </button>
                <button class="btn" style="flex: 1;" onclick="game.closeCombat()">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Map Modal -->
    <div class="modal" id="map-modal" onclick="game.closeMapOnBackground(event)">
        <div class="modal-content" style="max-width: 95vw; max-height: 95vh; padding: 10px; display: flex; flex-direction: column;" onclick="event.stopPropagation()">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                <h2 class="modal-heading" style="margin: 0; font-size: 1.15em; color: #d4af37;">ğŸ—ºï¸ Game Board</h2>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button onclick="game.showTips()" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 16px; color: #fff; background: rgba(100,100,100,0.9); border: 2px solid #d4af37; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.5);" title="Show gameplay tips">ğŸ’¡</button>
                    <button onclick="game.closeMap()" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; color: #fff; background: rgba(100,100,100,0.9); border: 2px solid #666; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.5);" title="Close map">Ã—</button>
                </div>
            </div>
            
            <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px; margin-bottom: 10px; border: 1px solid rgba(212,175,55,0.3);">
                <div style="font-family:'Cinzel',Georgia,serif;font-weight:700;color:#d4af37;font-size:1.05em;margin-bottom:8px;">âš¡ Actions</div>
                <div style="display: flex; gap: 5px; flex-wrap: wrap; align-items: center;">
                    <button class="phase-btn" id="foot-movement-btn" onclick="game.showFootMovement()" style="width:auto;margin-top:0;padding:6px 10px;font-size:0.8em;" title="Movement by foot â€” walk 1 adjacent location per action">
                        <span class="action-btn-icon">ğŸ¥¾ </span>Foot
                    </button>
                    <button class="phase-btn" id="horse-btn" onclick="game.showHorseMovement()" style="width:auto;margin-top:0;padding:6px 10px;font-size:0.8em;" title="Movement by horse">
                        <span class="action-btn-icon">ğŸ </span>Horse
                    </button>
                    <button class="phase-btn" id="eagle-btn" onclick="game.showEagleMovement()" style="width:auto;margin-top:0;padding:6px 10px;font-size:0.8em;" title="Movement by eagle">
                        <span class="action-btn-icon">ğŸ¦… </span>Eagle
                    </button>
                    <button class="phase-btn" id="magic-gate-btn" onclick="game.showMagicGateMovement()" style="width:auto;margin-top:0;padding:6px 10px;font-size:0.8em;" title="Movement by magic gate">
                        <span class="action-btn-icon">ğŸŒ€ </span>Magic Gate
                    </button>
                    <button class="phase-btn" id="special-skill-btn" onclick="game.useSpecialSkill()" style="width:auto;margin-top:0;padding:6px 10px;font-size:0.8em; display: none;" title="Perform special skill">
                        <span class="action-btn-icon">âœ¨ </span>Special Skill
                    </button>
                    <button class="phase-btn" id="fireball-btn" onclick="game.wizardFireball()" style="width:auto;margin-top:0;padding:6px 10px;font-size:0.8em; display: none;" title="Fireball: Discard matching card, 2+ defeats minions">
                        <span class="action-btn-icon">ğŸ”¥ </span>Fireball
                    </button>
                    <button class="phase-btn" id="archery-btn" onclick="game.archeryFromMap()" style="width:auto;margin-top:0;padding:6px 10px;font-size:0.8em; display: none;" title="Archery: Attack minions 1 space away">
                        <span class="action-btn-icon">ğŸ¹ </span>Archery
                    </button>
                    <button class="phase-btn" id="sanctify-land-btn" onclick="game.healLandCrystal()" style="width:auto;margin-top:0;padding:6px 10px;font-size:0.8em; display: none;" title="Sanctify Land: Heal tainted land without cards, roll 5+ to remove">
                        <span class="action-btn-icon">âœï¸ </span>Sanctify Land
                    </button>
                    <button class="phase-btn" id="build-magic-gate-btn" onclick="game.buildMagicGate()" disabled style="width:auto;margin-top:0;padding:6px 10px;font-size:0.8em;" title="Build a magic gate">
                        <span class="action-btn-icon">ğŸ’« </span>Build Magic Gate
                    </button>
                    <button class="phase-btn" id="rumors-btn" onclick="game.rumorsAction()" style="width:auto;margin-top:0;padding:6px 10px;font-size:0.8em;" title="Rumors at the Inn">
                        <span class="action-btn-icon">ğŸº </span>Rumors
                    </button>
                    <button class="phase-btn" id="crafty-btn" onclick="game.craftyAction()" style="width:auto;margin-top:0;padding:6px 10px;font-size:0.8em; display: none;" title="Crafty: Draw 5 cards at Inn, keep matching color + specials">
                        <span class="action-btn-icon">ğŸ—¡ï¸ </span>Crafty
                    </button>
                    <button class="phase-btn" id="heal-land-btn" onclick="game.healLandCrystal()" style="width:auto;margin-top:0;padding:6px 10px;font-size:0.8em;" title="Heal the Land">
                        <span class="action-btn-icon">ğŸŒ³ </span>Heal the Land
                    </button>
                    <button class="phase-btn" id="healing-wounds-btn" onclick="game.healingWoundsAction()" style="width:auto;margin-top:0;padding:6px 10px;font-size:0.8em;" title="Healing Wounds">
                        <span class="action-btn-icon">â¤ï¸ </span>Healing Wounds
                    </button>
                    <button class="phase-btn" id="engage-minions-btn" onclick="game.engageMinionsFromMap()" style="width:auto;margin-top:0;padding:6px 10px;font-size:0.8em;" title="Engage minions in combat">
                        <span class="action-btn-icon">âš”ï¸ </span>Engage Minions
                    </button>
                    <button class="phase-btn" id="attack-general-btn" onclick="game.attackGeneralFromMap()" style="width:auto;margin-top:0;padding:6px 10px;font-size:0.8em;" title="Attack an enemy general">
                        <span class="action-btn-icon">ğŸ‘¹ </span>Attack General
                    </button>
                    <button class="phase-btn" id="quest-cards-btn" onclick="game.showQuestCardsModal()" style="width:auto;margin-top:0;padding:6px 10px;font-size:0.8em;" title="View Quest Cards">
                        <span class="action-btn-icon">ğŸ“œ </span>Quests
                    </button>
                    <button class="phase-btn" id="complete-quest-btn" onclick="game.completeQuestAction()" disabled style="width:auto;margin-top:0;padding:6px 10px;font-size:0.8em;" title="Attempt to complete a quest at this location">
                        <span class="action-btn-icon">ğŸ¯ </span>Complete Quest
                    </button>
                    <button class="phase-btn" id="special-cards-btn" onclick="game.showSpecialCardsModal()" style="width:auto;margin-top:0;padding:6px 10px;font-size:0.8em;" title="Play a Special Card">
                        <span class="action-btn-icon">ğŸŒŸ </span>Special Cards
                    </button>
                    <button class="phase-btn" id="game-log-btn" onclick="game.showGameLogModal()" style="width:auto;margin-top:0;padding:6px 10px;font-size:0.8em;" title="View Game Log">
                        <span class="action-btn-icon">ğŸ“œ </span>Game Log
                    </button>
                    <button class="phase-btn" id="map-end-turn-btn" onclick="game.endTurnFromMap()" style="width:auto;margin-top:0;padding:6px 10px;font-size:0.8em;background:linear-gradient(135deg,#dc2626,#991b1b);border-color:#dc2626;color:#fff;"><span class="action-btn-icon">â­ï¸ </span>End Turn</button>
                </div>
            </div>
            
            <div class="hero-tray" onclick="game.onHeroTrayClick(event)" style="cursor: pointer;">
                <div class="hero-tray-row">
                    <div class="hero-tray-left">
                        <span class="tray-label"><span class="tray-label-text">Active Hero:</span><span class="tray-label-icon">Hero:</span></span>
                        <span id="map-active-hero" class="tray-value"></span>
                    </div>
                    <div id="map-hero-life-tokens" class="hero-tray-center"></div>
                    <div id="map-hero-action-tokens" class="hero-tray-right"></div>
                </div>
            </div>
            
            <div class="threat-tray">
                <div id="map-minion-tracker" class="threat-row"></div>
            </div>
            
            <div class="board-container" id="board-container" style="margin: 0; position: relative; overflow: hidden; touch-action: none; cursor: grab;">
                <svg id="game-map" viewBox="0 0 1000 700" preserveAspectRatio="xMidYMid meet" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: block; background: #000; transform-origin: center center;">
                    <!-- Background terrain -->
                    <defs>
                        <radialGradient id="cityGlow">
                            <stop offset="0%" style="stop-color:#FFD700;stop-opacity:0.5" />
                            <stop offset="100%" style="stop-color:#FFD700;stop-opacity:0" />
                        </radialGradient>
                        <filter id="shadow">
                            <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.3"/>
                        </filter>
                    </defs>
                    
                    <!-- Background map image -->
                    <image href="images/map-background.jpg" x="0" y="0" width="1000" height="700" preserveAspectRatio="none" />
                    
                    <!-- Paths between locations -->
                    <g id="paths" opacity="0.6" stroke="#654321" stroke-width="3" fill="none">
                    </g>
                    
                    <!-- Location circles will be added here -->
                    <g id="locations"></g>
                    
                    <!-- Token layer -->
                    <g id="token-layer-svg"></g>
                    
                    <!-- Effects layer for darkness spread animations -->
                    <g id="effects-layer"></g>
                </svg>
                
                <!-- Tooltip positioned relative to board-container (map area) -->
                <div class="hover-tooltip" id="hover-tooltip">
                    <div id="tooltip-content"></div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: center; align-items: center; gap: 10px; padding: 4px 0; font-size: 0.8em; color: #d4af37; font-family:'Cinzel',Georgia,serif;">
                <span>ğŸ“± Pinch to zoom â€¢ Drag to pan</span>
                <span onclick="game.resetMapZoom()" style="cursor: pointer; color: #d4af37; text-decoration: underline;" title="Reset zoom and position">ğŸ”„ Reset View</span>
            </div>
            
            <!-- Game log container (hidden, populated by addLog, read by showGameLogModal) -->
            <div id="game-log" style="display: none;"></div>
        </div>
    </div>

    <!-- Heroes Modal -->
    <div class="modal" id="heroes-modal" onclick="game.closeHeroesModal(event)" style="pointer-events: auto;">
        <div class="modal-content" onclick="event.stopPropagation()" style="pointer-events: auto; padding-top: 25px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 class="modal-title modal-heading" style="margin: 0; font-size: 1.2em;">ğŸ‘¥ Heroes</h2>
                <button onclick="game.closeHeroesModal()" style="width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 20px; color: #fff; background: rgba(100,100,100,0.9); border: 2px solid #666; border-radius: 50%; box-shadow: 0 2px 8px rgba(0,0,0,0.5);" title="Close">Ã—</button>
            </div>
            <div id="heroes-modal-list"></div>
        </div>
    </div>

    <!-- Hero Detail Modal -->
    <div class="modal" id="hero-detail-modal" onclick="game.closeHeroDetail(event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="padding-top: 20px;">
            <div id="hero-detail-content"></div>
        </div>
    </div>

    <!-- Location Actions Modal -->
    <div class="modal" id="location-actions-modal" onclick="game.closeLocationActions(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button onclick="game.closeLocationActions()" class="modal-close-btn">Ã—</button>
            <h2 class="modal-title" id="location-name-title"></h2>
            <div id="location-actions-content"></div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;" id="location-action-buttons">
            </div>
            <button class="btn" style="width: 100%; margin-top: 10px;" onclick="game.closeLocationActions()">
                Close
            </button>
        </div>
    </div>

    <!-- Hero Death Modal -->
    <div class="modal" id="hero-death-modal" style="z-index: 45000;">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 class="modal-title" style="color: #ef4444;">ğŸ’€ Hero Defeated!</h2>
            <div id="hero-death-content"></div>
            <div id="hero-selection-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 20px 0;"></div>
            <button class="btn" id="respawn-same-hero-btn" style="width: 100%; margin-top: 10px;" onclick="game.respawnSameHero()">
                Respawn Same Hero
            </button>
        </div>
    </div>

    <!-- Retreat to Monarch City Modal -->
    <div class="modal" id="retreat-modal">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 class="modal-title" style="color: #ef4444;">âš ï¸ Failed to Defeat General!</h2>
            <div id="retreat-content"></div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="game.closeRetreatModal()">
                Continue
            </button>
        </div>
    </div>

    <!-- Card Draw Modal -->
    <div class="modal" id="card-modal">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button onclick="game.closeCardModal()" class="modal-close-btn">Ã—</button>
            <h2 class="modal-title">Card Drawn!</h2>
            <div id="card-display"></div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="game.closeCardModal()">
                Continue
            </button>
        </div>
    </div>

    <!-- Combat Results Modal -->
    <div class="modal" id="combat-results-modal" style="z-index: 16000;">
        <div class="modal-content" onclick="event.stopPropagation()">
            <button onclick="game.closeCombatResults()" class="modal-close-btn">Ã—</button>
            <h2 class="modal-title">Combat Results</h2>
            <div id="combat-results-content"></div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="game.closeCombatResults()">
                Continue
            </button>
        </div>
    </div>

    <!-- Group Penalty Modal -->
    <div class="modal" id="group-penalty-modal">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 class="modal-title" style="color: #ef4444;">ğŸ¤ Group Defeated!</h2>
            <div id="group-penalty-content"></div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="game.closeGroupPenaltyModal()">
                Continue
            </button>
        </div>
    </div>

    <!-- Darkness Spreads Modal -->
    <div class="modal" id="darkness-modal">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 class="modal-title" style="color: #ef4444;">âš ï¸ Darkness Spreads âš ï¸</h2>
            <div id="darkness-content"></div>
            <button class="btn btn-danger" style="width: 100%; margin-top: 15px;" onclick="game.closeDarknessModal()">
                Continue
            </button>
        </div>
    </div>

    <!-- Card Discard Modal -->
    <div class="modal" id="card-discard-modal">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 class="modal-title" style="color: #ef4444;">Discard Cards</h2>
            <div id="card-discard-reason" style="margin-bottom: 15px; color: #d4af37;"></div>
            <div id="card-discard-instruction" style="margin-bottom: 15px;"></div>
            <div id="card-discard-cards" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 15px;"></div>
            <button class="btn btn-primary" id="confirm-discard-btn" onclick="game.confirmCardDiscard()" disabled style="width: 100%;">
                Discard Selected Cards
            </button>
        </div>
    </div>


    <!-- â•â•â• DATA MODULES â•â•â• -->
    <script src="js/data/locations.js"></script>
    <script src="js/data/heroes.js"></script>
    <script src="js/data/generals.js"></script>
    <script src="js/data/cards.js"></script>
    <script src="js/data/quests.js"></script>

    <!-- â•â•â• CORE GAME STATE â•â•â• -->
    <script src="js/game.js"></script>

    <!-- â•â•â• SYSTEMS â•â•â• -->
    <script src="js/systems/setup.js"></script>
    <script src="js/systems/quest-system.js"></script>
    <script src="js/systems/special-effects.js"></script>
    <script src="js/systems/combat-general.js"></script>
    <script src="js/systems/movement.js"></script>
    <script src="js/systems/combat-minion.js"></script>
    <script src="js/systems/actions.js"></script>
    <script src="js/systems/land-turns.js"></script>
    <script src="js/systems/darkness-ai.js"></script>
    <script src="js/systems/hero-abilities.js"></script>
    <script src="js/systems/game-status.js"></script>

    <!-- â•â•â• UI â•â•â• -->
    <script src="js/ui/map-render.js"></script>
    <script src="js/ui/panels.js"></script>
    <script src="js/ui/turn-modals.js"></script>

    <!-- â•â•â• INITIALIZE â•â•â• -->
    <script>
        // Initialize game object
        game.init();
    </script>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content" style="max-width: 550px;">
            <h2 class="modal-title" style="color: #d4af37;">âš™ï¸ Game Settings</h2>
            <div style="color: #999; font-size: 0.85em; margin-bottom: 15px; text-align: center;">Adjust difficulty by toggling conditions on or off.</div>
            
            <div style="margin-bottom: 20px;">
                <div style="color: #ef4444; font-weight: bold; font-size: 1.1em; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #333;">
                    ğŸ’€ Lose Conditions
                </div>
                
                <label style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; margin-bottom: 6px; background: rgba(0,0,0,0.3); border-radius: 6px; cursor: pointer; border: 1px solid transparent; transition: border-color 0.2s;" onmouseover="this.style.borderColor='#555'" onmouseout="this.style.borderColor='transparent'">
                    <input type="checkbox" id="setting-check-general-monarch" checked style="margin-top: 3px; width: 18px; height: 18px; min-width: 18px; min-height: 18px; flex-shrink: 0; cursor: pointer; accent-color: #ef4444;">
                    <div>
                        <div style="color: #ffd700; font-weight: bold;">ğŸ‘¹ General Reaches Monarch City</div>
                        <div style="color: #999; font-size: 0.85em;">Game over if any general reaches Monarch City</div>
                    </div>
                </label>
                
                <label style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; margin-bottom: 6px; background: rgba(0,0,0,0.3); border-radius: 6px; cursor: pointer; border: 1px solid transparent; transition: border-color 0.2s;" onmouseover="this.style.borderColor='#555'" onmouseout="this.style.borderColor='transparent'">
                    <input type="checkbox" id="setting-check-monarch-minions" checked style="margin-top: 3px; width: 18px; height: 18px; min-width: 18px; min-height: 18px; flex-shrink: 0; cursor: pointer; accent-color: #ef4444;">
                    <div>
                        <div style="color: #ffd700; font-weight: bold;">ğŸ° Monarch City Overrun (5 Minions)</div>
                        <div style="color: #999; font-size: 0.85em;">Game over if 5 minions accumulate in Monarch City</div>
                    </div>
                </label>
                
                <label style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; margin-bottom: 6px; background: rgba(0,0,0,0.3); border-radius: 6px; cursor: pointer; border: 1px solid transparent; transition: border-color 0.2s;" onmouseover="this.style.borderColor='#555'" onmouseout="this.style.borderColor='transparent'">
                    <input type="checkbox" id="setting-check-taint-crystals" checked style="margin-top: 3px; width: 18px; height: 18px; min-width: 18px; min-height: 18px; flex-shrink: 0; cursor: pointer; accent-color: #ef4444;">
                    <div>
                        <div style="color: #ffd700; font-weight: bold;">ğŸ’ 12 Tainted Crystals Placed</div>
                        <div style="color: #999; font-size: 0.85em;">Game over if all 12 taint crystals are on the board</div>
                    </div>
                </label>
                
                <label style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; margin-bottom: 6px; background: rgba(0,0,0,0.3); border-radius: 6px; cursor: pointer; border: 1px solid transparent; transition: border-color 0.2s;" onmouseover="this.style.borderColor='#555'" onmouseout="this.style.borderColor='transparent'">
                    <input type="checkbox" id="setting-check-minion-exhaustion" checked style="margin-top: 3px; width: 18px; height: 18px; min-width: 18px; min-height: 18px; flex-shrink: 0; cursor: pointer; accent-color: #ef4444;">
                    <div>
                        <div style="color: #ffd700; font-weight: bold;">ğŸ‘¤ Minion Exhaustion (25 per faction)</div>
                        <div style="color: #999; font-size: 0.85em;">Game over if all 25 minions of a faction are on the board and more are needed</div>
                    </div>
                </label>
            </div>
            
            <div style="margin-bottom: 20px;">
                <div style="color: #f59e0b; font-weight: bold; font-size: 1.1em; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #333;">
                    âš¡ Gameplay Rules
                </div>
                
                <label style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; margin-bottom: 6px; background: rgba(0,0,0,0.3); border-radius: 6px; cursor: pointer; border: 1px solid transparent; transition: border-color 0.2s;" onmouseover="this.style.borderColor='#555'" onmouseout="this.style.borderColor='transparent'">
                    <input type="checkbox" id="setting-check-overruns" checked style="margin-top: 3px; width: 18px; height: 18px; min-width: 18px; min-height: 18px; flex-shrink: 0; cursor: pointer; accent-color: #ef4444;">
                    <div>
                        <div style="color: #ffd700; font-weight: bold;">ğŸ’¥ Overrun Rule</div>
                        <div style="color: #999; font-size: 0.85em;">4th minion at a location spreads to all connected locations. Disabling caps minions at 3 per location with no spread.</div>
                    </div>
                </label>
                
                <label style="display: flex; align-items: flex-start; gap: 10px; padding: 10px; margin-bottom: 6px; background: rgba(0,0,0,0.3); border-radius: 6px; cursor: pointer; border: 1px solid transparent; transition: border-color 0.2s;" onmouseover="this.style.borderColor='#555'" onmouseout="this.style.borderColor='transparent'">
                    <input type="checkbox" id="setting-check-war-tracker-lock" style="margin-top: 3px; width: 18px; height: 18px; min-width: 18px; min-height: 18px; flex-shrink: 0; cursor: pointer; accent-color: #ef4444;">
                    <div>
                        <div style="color: #ffd700; font-weight: bold;">ğŸ”’ Lock War Tracker at Early War</div>
                        <div style="color: #999; font-size: 0.85em;">Prevents the war tracker from advancing past Early War. Generals move less frequently and minion spawns stay low.</div>
                    </div>
                </label>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn btn-primary" onclick="game.confirmSettings()" style="padding: 10px 30px; font-size: 1.05em;">Confirm</button>
                <button class="btn btn-primary" onclick="game.cancelSettings()" style="padding: 10px 30px; font-size: 1.05em;">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Rules Modal -->
    <div id="rules-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <button onclick="game.closeRules()" class="modal-close-btn">Ã—</button>
            <h2 style="color: #ffd700; text-align: center;">ğŸ“œ Defenders of the Realm - Rules</h2>
            
            <div style="padding: 20px;">
                <h3 style="color: #ffd700;">ğŸ¯ Win Condition</h3>
                <p><strong>Victory:</strong> Defeat all 4 generals (Balazarg, Gorgutt, Varkolak, Sapphire)</p>
                
                <h3 style="color: #ffd700; margin-top: 20px;">ğŸ’€ Lose Conditions (ANY triggers defeat)</h3>
                <ul>
                    <li><strong>General Reaches Monarch City:</strong> If any general moves to Monarch City</li>
                    <li><strong>5 Minions on Monarch City:</strong> If 5 minions TOTAL (any combination) occupy Monarch City</li>
                    <li><strong>12 Taint Crystals:</strong> If all 12 taint crystals are placed on the board</li>
                    <li><strong>25 Minions of Any Color:</strong> If all 25 tokens of any single faction are deployed and more are needed</li>
                </ul>
                <p style="font-size: 0.9em; color: #999;">Lose conditions can be individually toggled in âš™ï¸ Settings.</p>
                
                <h3 style="color: #ffd700; margin-top: 20px;">âš”ï¸ War Status</h3>
                <p>The war escalates as generals fall. Each phase increases the number of Darkness Spreads cards drawn per Night Phase:</p>
                <ul>
                    <li><strong style="color: #4ade80;">Early War</strong> (start): Draw 1 Darkness card per Night Phase</li>
                    <li><strong style="color: #fbbf24;">Mid War</strong> (1st general defeated): Draw 2 cards â€” Card 2 is general advance only (minion placements skipped)</li>
                    <li><strong style="color: #ef4444;">Late War</strong> (3rd general defeated): Draw 3 cards â€” Card 3 is general advance only</li>
                </ul>
                
                <h3 style="color: #ffd700; margin-top: 20px;">ğŸ”„ Turn Structure (3 Phases)</h3>
                <p>Each hero's turn ends with three sequential phases:</p>
                <ul>
                    <li><strong>Step 1 â€” Daytime:</strong> Hero takes damage from minions at their current location</li>
                    <li><strong>Step 2 â€” Evening:</strong> Draw 2 hero cards. If over 10 cards, must discard down to 10</li>
                    <li><strong>Step 3 â€” Night:</strong> Draw Darkness Spreads card(s) based on War Status. Cards are shown one at a time with a preview, then resolved individually</li>
                </ul>
                
                <h3 style="color: #ffd700; margin-top: 20px;">ğŸŒ™ Darkness Spreads (Night Phase)</h3>
                <p>Each Darkness card is previewed before resolution. The preview shows warnings for:</p>
                <ul>
                    <li><strong>Overrun:</strong> If a 4th minion of the same color would be placed, it triggers an overrun â€” minions spread to connected locations</li>
                    <li><strong>Taint Crystal:</strong> If a location overflows, a taint crystal is placed</li>
                    <li><strong>General Advance:</strong> Whether the general will move toward Monarch City or be blocked</li>
                    <li><strong>General-Only Cards:</strong> In Mid/Late War, extra cards skip minion placements and only advance generals</li>
                </ul>
                
                <h3 style="color: #ffd700; margin-top: 20px;">ğŸ’ Overrun & Taint Mechanics</h3>
                <ul>
                    <li><strong>Overrun (4th Minion Rule):</strong> When a 4th minion of the same color would be placed at a location, a taint crystal is placed and the excess minions spread to each connected location</li>
                    <li><strong>Taint Crystals:</strong> Placed when locations overflow with minions. 12 total taint crystals triggers a lose condition</li>
                    <li><strong>ğŸŒ³ Heal the Land:</strong> Remove taint crystals by spending matching cards at the location</li>
                </ul>
                
                <h3 style="color: #ffd700; margin-top: 20px;">ğŸ® Actions</h3>
                <p><strong>Actions per turn = Life tokens.</strong> Each hero has a different amount of life tokens (e.g. Paladin has 6, Eagle Rider has 4). Taking wounds reduces both life and available actions.</p>
                <ul>
                    <li>Heroes start with <strong>2 cards</strong></li>
                    <li>Each turn: draw <strong>2 cards</strong> during Evening phase</li>
                    <li><strong>Hand Limit:</strong> Maximum 10 cards â€” must discard excess after drawing</li>
                    <li><strong>Death at 0 life tokens:</strong> Discard all cards, respawn at Monarch City</li>
                </ul>
                
                <h4 style="color: #ffd700; margin-top: 15px;">Action Tray Buttons:</h4>
                <ul>
                    <li><strong>ğŸ¥¾ Foot:</strong> Walk to an adjacent connected location (1 action per space)</li>
                    <li><strong>ğŸ Horse:</strong> Discard a matching horse card to travel 2 spaces</li>
                    <li><strong>ğŸ¦… Eagle:</strong> Discard a matching eagle card to fly 4 spaces</li>
                    <li><strong>ğŸŒ€ Magic Gate:</strong> Travel between magic gate locations (free if at a gate, or discard a Magic Gate card from anywhere)</li>
                    <li><strong>ğŸ’« Build Magic Gate:</strong> Spend an action + Magic Gate cards to build a permanent gate at your location</li>
                    <li><strong>ğŸº Rumors:</strong> At an Inn, draw 2 cards (costs 1 action, usable twice per turn)</li>
                    <li><strong>ğŸŒ³ Heal the Land:</strong> Spend matching cards to remove a taint crystal at your location</li>
                    <li><strong>â¤ï¸ Healing Wounds:</strong> Heal 1 wound per action at a safe location (no minions/generals) OR full heal at an Inn or Monarch City for 1 action</li>
                    <li><strong>âš”ï¸ Engage Minions:</strong> Roll dice to fight minions at your location (1 die per matching card)</li>
                    <li><strong>ğŸ‘¹ Attack General:</strong> Fight a general at your location (only when no minions present). Discard matching cards to roll dice</li>
                    <li><strong>ğŸ“œ Quests:</strong> View your quest cards and attempt to complete quests at the required location</li>
                    <li><strong>ğŸŒŸ Special Cards:</strong> Play a purple Special Card from any hero's hand for its unique effect</li>
                    <li><strong>â­ï¸ End Turn:</strong> End your turn and begin the 3-phase turn resolution</li>
                </ul>
                <p style="font-size: 0.9em; color: #999;">Some heroes have additional action buttons (ğŸ”¥ Fireball, ğŸ¹ Archery, âœï¸ Sanctify Land, ğŸ—¡ï¸ Crafty) that appear when conditions are met. See hero ability details in the Heroes modal.</p>
                
                <h3 style="color: #ffd700; margin-top: 20px;">ğŸ“œ Quest Cards</h3>
                <ul>
                    <li>Each hero draws <strong>1 quest card</strong> at game start</li>
                    <li>Quests require traveling to a <strong>specific location</strong> and spending 1 action to attempt a dice roll</li>
                    <li>The <strong>ğŸ¯ Complete Quest</strong> button appears on the action tray when at a quest location</li>
                    <li>On <strong>success</strong>: the quest reward activates and a new quest is drawn from the deck</li>
                    <li>On <strong>failure</strong>: most quest cards are discarded and a new one is drawn. Some quests (like War Banner of Valor) can be reattempted</li>
                    <li><strong>Quest types:</strong>
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            <li><strong>Magic Items</strong> (passive): Amulet of the Gods (+1 combat dice), Boots of Speed (+2 actions), Helm of Power (+1 card draw), War Banner of Valor (ignore defeat penalties)</li>
                            <li><strong>Use-Anytime</strong> (active): Crystal of Light (remove taint at your location), Ancient Tree of Magic (remove taint from any location). These stay on the hero after completion and are discarded when used</li>
                            <li><strong>Placeholder quests</strong>: Can be completed but reward not yet implemented</li>
                        </ul>
                    </li>
                    <li>Use the <strong>ğŸ“œ Quests</strong> button to view quest details, see the location on the map, or use completed quest cards</li>
                </ul>
                
                <h3 style="color: #ffd700; margin-top: 20px;">âš”ï¸ Combat</h3>
                <ul>
                    <li><strong>Minions & Generals:</strong> Hit requirements vary by faction:
                        <ul style="margin-left: 20px; margin-top: 5px;">
                            <li>ğŸŸ¢ <strong>Orcs (Green):</strong> 3+ to hit (easier)</li>
                            <li>âš« <strong>Undead (Black):</strong> 4+ to hit</li>
                            <li>ğŸ”´ <strong>Demons (Red):</strong> 4+ to hit</li>
                            <li>ğŸ”µ <strong>Dragons (Blue):</strong> 5+ to hit (harder)</li>
                        </ul>
                    </li>
                    <li><strong>Generals:</strong> Each general has unique health. Use matching faction cards to roll dice.</li>
                    <li><strong>Group Attacks:</strong> Multiple heroes at the same location can coordinate attacks on a general</li>
                    <li><strong>Failed Minion Attacks:</strong> Take 1 wound when failing to kill all minions</li>
                    <li><strong>Failed General Attacks:</strong> Each general has unique defeat penalties (wounds + card loss). The War Banner of Valor quest item negates these penalties</li>
                </ul>
                
                <h3 style="color: #ffd700; margin-top: 20px;">ğŸ‘¹ General Combat Skills</h3>
                <ul>
                    <li><strong>Balazarg (Red/Demons):</strong> Demonic Curse â€” Roll D6 per card before battle, discard card on 1. Defeat penalty: D3 wounds + ALL cards</li>
                    <li><strong>Gorgutt (Green/Orcs):</strong> Parry â€” Each 1 rolled eliminates 1 hit. Defeat penalty: 2 wounds + 2 cards</li>
                    <li><strong>Varkolak (Black/Undead):</strong> No Re-rolls â€” Heroes cannot re-roll dice. Defeat penalty: D6 wounds + D6 cards</li>
                    <li><strong>Sapphire (Blue/Dragons):</strong> Regeneration â€” Returns to full health if not defeated in one attack. Defeat penalty: 3 wounds + D6 cards</li>
                </ul>
                
                <h3 style="color: #f59e0b; margin-top: 20px;">âš”ï¸ General Wounds &amp; Healing</h3>
                <ul>
                    <li><strong>Minor Wounds:</strong> When a general takes damage but survives. Healing begins after a 1 turn delay.</li>
                    <li><strong>Major Wounds:</strong> A more severe injury. Healing delayed until a full round of player turns completes. <strong style="color: #ef4444;">Generals with Major Wounds cannot advance!</strong></li>
                    <li><strong>Healing Rate:</strong> Once healing begins, generals heal +1 HP at the end of each player's turn.</li>
                    <li><strong>Major Wound Thresholds:</strong> Gorgutt at â‰¤2 HP, Balazarg at â‰¤1 HP. Varkolak cannot have major wounds.</li>
                    <li><strong>Sapphire:</strong> Ignores the wound/healing system entirely due to Regeneration.</li>
                </ul>
                
                <h3 style="color: #9333ea; margin-top: 20px;">ğŸŒŸ Special Cards</h3>
                <ul>
                    <li><strong>Purple cards</strong> in the hero deck are Special Cards with unique effects.</li>
                    <li>Special cards can be <strong>played at any time</strong> without using an action via the ğŸŒŸ Special Cards button.</li>
                    <li>Alternatively, they can be used in <strong>general combat</strong> for their dice value against their specified faction.</li>
                    <li>Any hero can play a special card held by any other hero.</li>
                    <li><strong>ğŸ’« Magic Gate:</strong> Place a Magic Gate on any location (2 dice vs Undead in combat).</li>
                    <li><strong>ğŸ”¨ Hammer of Valor:</strong> Move any hero to any location (2 dice vs any General in combat).</li>
                    <li><strong>âœ¨ Spell of Purity:</strong> Remove all Tainted Crystals from a single location (2 dice vs Demons in combat).</li>
                    <li><strong>ğŸ¹ Elven Archers:</strong> Remove all enemy minions from 2 Green locations (1 die vs Orcs in combat).</li>
                    <li><strong>âš”ï¸ Battle Strategy:</strong> Defeat all minions on any 3 locations, then push 1 General back a location (2 dice vs any General in combat).</li>
                    <li><strong>ğŸŒ… All Is Quiet:</strong> Skip Darkness Spreads â€” no cards are drawn this turn (2 dice vs Orcs in combat).</li>
                    <li><strong>ğŸ€ Battle Luck:</strong> During any combat, re-roll all failed dice. Cannot be used against Varkolak (1 die vs any General in combat).</li>
                    <li><strong>ğŸ’¥ Battle Fury:</strong> Defeat all enemy minions at the active hero's current location. <span style="color: #ef4444;">Requires 1 Action.</span> (2 dice vs Dragonkin in combat).</li>
                    <li><strong>ğŸ“œ Local Information:</strong> At an Inn, draw 5 cards â€” keep all that match a chosen color and all Special cards (1 die vs any General in combat).</li>
                    <li><strong>ğŸ‘‘ King's Guard Attack:</strong> Remove up to 6 minions on or adjacent to Monarch City (1 die vs Dragonkin in combat).</li>
                    <li><strong>ğŸ Cavalry Sweep:</strong> Sweep through adjacent locations removing up to 6 minions (max 2 per location). <span style="color: #ef4444;">Dragonkin count as 2.</span> (1 die vs any General in combat).</li>
                    <li><strong>ğŸ”® Dark Visions:</strong> View top 5 Darkness Spreads cards. Discard any to avoid, return rest in chosen order (1 die vs any General in combat).</li>
                    <li><strong>ğŸ›¡ï¸ Militia Secures Area:</strong> During Night Phase, cancel 1 minion placement from a Darkness Spreads card (1 die vs Undead in combat).</li>
                    <li><strong>ğŸ° Strong Defenses:</strong> During Night Phase, prevent the General from moving on a Darkness Spreads card (1 die vs Demons in combat).</li>
                    <li><strong>ğŸ‘¤ Spy In The Camp:</strong> During Daytime, prevent 1 wounded General from healing for the active hero's turn (1 die vs any General in combat).</li>
                </ul>
                
                <h3 style="color: #ffd700; margin-top: 20px;">ğŸ—ºï¸ Map Features</h3>
                <ul>
                    <li><strong>Colored Paths:</strong> Show general movement routes to Monarch City</li>
                    <li><strong>Purple Locations:</strong> Monarch City and Inns (special locations)</li>
                    <li><strong>ğŸŒ€ Magic Gates:</strong> Teleport between gate locations or build new ones</li>
                    <li><strong>ğŸ’ Taint Crystals:</strong> Corrupted locations shown on map tooltips</li>
                </ul>
                
                <div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 2px solid #8B7355;">
                    <button class="btn btn-primary" onclick="game.closeRules()">Close Rules</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rumors Modal (shows both cards at once) -->
    <div id="rumors-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <button onclick="game.closeRumorsModal()" class="modal-close-btn">Ã—</button>
            <h2 class="modal-title">ğŸº Rumors Gathered</h2>
            <div id="rumors-content"></div>
            <button class="btn btn-primary" onclick="game.closeRumorsModal()" style="width: 100%; margin-top: 15px;">Continue</button>
        </div>
    </div>
    
    <!-- General Defeat Reward Modal -->
    <div id="general-reward-modal" class="modal" style="z-index: 16000;">
        <div class="modal-content" style="max-width: 700px;">
            <button onclick="game.closeGeneralRewardModal()" class="modal-close-btn">Ã—</button>
            <h2 class="modal-title">ğŸ‰ General Defeated - Rewards! ğŸ‰</h2>
            <div id="general-reward-content"></div>
            <button class="btn btn-primary" onclick="game.closeGeneralRewardModal()" style="width: 100%; margin-top: 15px;">Continue</button>
        </div>
    </div>
    
    <!-- Victory Modal -->
    <div id="victory-modal" class="modal" style="z-index: 50000;">
        <div class="modal-content" style="max-width: 600px;">
            <div id="victory-content"></div>
        </div>
    </div>
    
    <!-- Game Over Modal -->
    <div id="game-over-modal" class="modal" style="z-index: 50000;">
        <div class="modal-content" style="max-width: 600px; text-align: center;">
            <div id="game-over-content"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="location.reload()" style="flex: 1; font-size: 1.1em;">
                    Start New Game
                </button>
                <button class="btn btn-primary" onclick="game.continueGame()" style="flex: 1; font-size: 1.1em;">
                    Continue Game
                </button>
            </div>
        </div>
    </div>
    
    <!-- Generic Info Modal (replaces alerts) -->
    <div id="info-modal" class="modal" style="z-index: 40000;">
        <div class="modal-content" style="max-width: 500px; padding-top: 20px;">
            <h2 id="info-modal-title" class="modal-title"></h2>
            <div id="info-modal-content" style="color: #f4e4c1;"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="game.closeInfoModal()">Continue</button>
            </div>
        </div>
    </div>
    
    <!-- End of Turn Modal -->
    <div id="end-of-turn-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <button onclick="game.closeEndOfTurnModal()" class="modal-close-btn">Ã—</button>
            <div id="end-of-turn-content"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button id="end-of-turn-btn" class="phase-btn" onclick="game.closeEndOfTurnModal()">Continue</button>
            </div>
        </div>
    </div>
    
    <!-- Hand Limit Modal -->
    <div id="hand-limit-modal" class="modal" style="z-index: 15500;">
        <div class="modal-content" style="max-width: 650px;">
            <div id="hand-limit-content"></div>
            <div style="text-align: center; margin-top: 15px;">
                <button id="hand-limit-confirm-btn" class="phase-btn" disabled onclick="game.confirmHandLimitDiscard()" style="opacity: 0.5;">Confirm Discard</button>
            </div>
        </div>
    </div>
    
    <!-- Wizard Teleport Modal -->
    <div id="wizard-teleport-modal" class="modal" style="z-index: 15000;">
        <div class="modal-content" style="max-width: 500px;">
            <h2 class="modal-title">âœ¨ Wizard Teleport</h2>
            <div id="wizard-teleport-content"></div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button class="btn" onclick="game.closeWizardTeleport()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Card Detail Modal (standalone, used from tooltips) -->
    <div id="card-detail-modal" class="modal" style="z-index: 30000;">
        <div class="modal-content" style="max-width: 500px; padding-top: 20px;">
            <div id="card-detail-content"></div>
        </div>
    </div>
    
    <!-- Eagle Rider Attack Style Modal -->
    <div id="eagle-attack-style-modal" class="modal" style="z-index: 42000;">
        <div class="modal-content" style="max-width: 520px;">
            <h2 class="modal-title">ğŸ¦… Eagle Rider â€” Choose Attack Style</h2>
            <p style="color: #d4af37; margin-bottom: 18px; text-align: center;">You must choose one attack style for this entire turn.</p>
            <div style="display: flex; flex-direction: column; gap: 14px;">
                <button id="eagle-sky-btn" onclick="game.selectEagleAttackStyle('sky')" style="
                    background: linear-gradient(135deg, #1e3a5f 0%, #0c2340 100%);
                    border: 3px solid #60a5fa;
                    border-radius: 12px;
                    padding: 18px 20px;
                    color: #f4e4c1;
                    cursor: pointer;
                    text-align: left;
                    transition: all 0.2s;
                ">
                    <div style="font-size: 1.3em; font-weight: bold; color: #60a5fa; margin-bottom: 8px;">
                        â˜ï¸ Sky Attack
                    </div>
                    <div style="font-size: 0.92em; line-height: 1.5;">
                        May end turn in the same location with enemy minions or Generals but suffers <strong style="color: #4ade80;">no penalties</strong> (fear, damage, or loss of cards).
                    </div>
                </button>
                <button id="eagle-ground-btn" onclick="game.selectEagleAttackStyle('ground')" style="
                    background: linear-gradient(135deg, #5c3a1e 0%, #3d2510 100%);
                    border: 3px solid #f59e0b;
                    border-radius: 12px;
                    padding: 18px 20px;
                    color: #f4e4c1;
                    cursor: pointer;
                    text-align: left;
                    transition: all 0.2s;
                ">
                    <div style="font-size: 1.3em; font-weight: bold; color: #f59e0b; margin-bottom: 8px;">
                        âš”ï¸ Ground Attack
                    </div>
                    <div style="font-size: 0.92em; line-height: 1.5;">
                        May <strong style="color: #fbbf24;">re-roll all dice one time</strong> each combat against minions and Generals (except Undead General). But rider is on the ground at end of turn and is subject to penalties.
                    </div>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Shape Shifter Modal (Sorceress turn start) -->
    <div id="shapeshift-modal" class="modal" style="z-index: 42000;">
        <div class="modal-content" style="max-width: 520px;">
            <h2 class="modal-title">âš¡ Shape Shifter â€” Choose Form</h2>
            <p style="color: #d4af37; margin-bottom: 8px; text-align: center;">Choose a faction to shape shift into. You will be immune to minion wounds from that faction this turn.</p>
            <p style="color: #ef4444; font-size: 0.85em; margin-bottom: 18px; text-align: center;">âš ï¸ Cannot enter Monarch City or Inns in enemy form</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 18px;" id="shapeshift-options">
                <div id="ss-opt-green" onclick="game._ssSelect('green')" style="border: 3px solid #16a34a; cursor: pointer; padding: 14px; border-radius: 10px; background: rgba(0,0,0,0.3); transition: all 0.2s; text-align: center;"
                     onmouseover="if(!this.classList.contains('ss-active')) this.style.background='rgba(255,255,255,0.08)'"
                     onmouseout="if(!this.classList.contains('ss-active')) this.style.background='rgba(0,0,0,0.3)'">
                    <div><span style="display:inline-block;width:28px;height:28px;border-radius:50%;background:#16a34a;border:2px solid #000;"></span></div>
                    <div style="color: #16a34a; font-weight: bold; margin-top: 4px;">Orc</div>
                    <div style="color: #999; font-size: 0.8em;">Immune to Orc wounds</div>
                </div>
                <div id="ss-opt-black" onclick="game._ssSelect('black')" style="border: 3px solid #6b7280; cursor: pointer; padding: 14px; border-radius: 10px; background: rgba(0,0,0,0.3); transition: all 0.2s; text-align: center;"
                     onmouseover="if(!this.classList.contains('ss-active')) this.style.background='rgba(255,255,255,0.08)'"
                     onmouseout="if(!this.classList.contains('ss-active')) this.style.background='rgba(0,0,0,0.3)'">
                    <div><span style="display:inline-block;width:28px;height:28px;border-radius:50%;background:#1f2937;border:2px solid #000;"></span></div>
                    <div style="color: #6b7280; font-weight: bold; margin-top: 4px;">Undead</div>
                    <div style="color: #ef4444; font-size: 0.8em;">Still subject to fear</div>
                </div>
                <div id="ss-opt-red" onclick="game._ssSelect('red')" style="border: 3px solid #dc2626; cursor: pointer; padding: 14px; border-radius: 10px; background: rgba(0,0,0,0.3); transition: all 0.2s; text-align: center;"
                     onmouseover="if(!this.classList.contains('ss-active')) this.style.background='rgba(255,255,255,0.08)'"
                     onmouseout="if(!this.classList.contains('ss-active')) this.style.background='rgba(0,0,0,0.3)'">
                    <div><span style="display:inline-block;width:28px;height:28px;border-radius:50%;background:#dc2626;border:2px solid #000;"></span></div>
                    <div style="color: #dc2626; font-weight: bold; margin-top: 4px;">Demon</div>
                    <div style="color: #999; font-size: 0.8em;">Immune to Demon wounds</div>
                </div>
                <div id="ss-opt-blue" onclick="game._ssSelect('blue')" style="border: 3px solid #3b82f6; cursor: pointer; padding: 14px; border-radius: 10px; background: rgba(0,0,0,0.3); transition: all 0.2s; text-align: center;"
                     onmouseover="if(!this.classList.contains('ss-active')) this.style.background='rgba(255,255,255,0.08)'"
                     onmouseout="if(!this.classList.contains('ss-active')) this.style.background='rgba(0,0,0,0.3)'">
                    <div><span style="display:inline-block;width:28px;height:28px;border-radius:50%;background:#2563eb;border:2px solid #000;"></span></div>
                    <div style="color: #3b82f6; font-weight: bold; margin-top: 4px;">Dragon</div>
                    <div style="color: #999; font-size: 0.8em;">Immune to Dragon wounds</div>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn" style="flex: 1; background: #666;" onclick="game.selectShapeshiftForm(null)" title="Stay in normal form â€” no immunity, can freely enter Monarch City and Inns">Ignore</button>
                <button id="ss-confirm-btn" class="btn" style="flex: 1; opacity: 0.5; cursor: not-allowed; background: #666;" disabled onclick="game._ssConfirm()">Confirm</button>
            </div>
        </div>
    </div>
    
</body>
</html>
